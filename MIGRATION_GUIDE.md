# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (Many-to-Many)

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

### –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∏—Ç–∞–Ω–∏—è –ø—Ä–∏–≤—è–∑—ã–≤–∞–ª–∞—Å—å –∫ –æ–¥–Ω–æ–º—É –≥–æ—Ä–æ–¥—É —á–µ—Ä–µ–∑ `city_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `nutrition_programs`
- –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∞—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞

### –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∏—Ç–∞–Ω–∏—è –ù–ï –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é –∫ –≥–æ—Ä–æ–¥—É
- –°–≤—è–∑—å –ø—Ä–æ–≥—Ä–∞–º–º –∏ –≥–æ—Ä–æ–¥–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `city_nutrition_programs` (many-to-many)
- –û–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–æ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–∞—Ö –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

1. **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≥—Ä–∞–º–º–∞ "–ë–∞–ª–∞–Ω—Å" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –æ–¥–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ
2. **–õ–µ–≥–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å** - –∏–∑–º–µ–Ω–∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –æ–¥–∏–Ω —Ä–∞–∑ ‚Üí –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ–∑–¥–µ
3. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≥–æ—Ä–æ–¥–∞—Ö
4. **–ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö** - –º–µ–Ω—å—à–µ —Å—Ç—Ä–æ–∫ –≤ –ë–î, –±—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—Ä–æ—Å—ã

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –ï—Å–ª–∏ –ë–î —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ):

```bash
# 1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
psql -U postgres -d fitbox -f migrations/003_convert_to_many_to_many.sql

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
psql -U postgres -d fitbox -c "SELECT * FROM city_nutrition_programs;"

# 3. –ï—Å–ª–∏ –≤—Å–µ –æ–∫, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ 003_convert_to_many_to_many.sql —Å—Ç—Ä–æ–∫—É:
# ALTER TABLE nutrition_programs DROP COLUMN IF EXISTS city_id;

# –ò –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ—â–µ —Ä–∞–∑
psql -U postgres -d fitbox -f migrations/003_convert_to_many_to_many.sql
```

### –ï—Å–ª–∏ –ë–î –ø—É—Å—Ç–∞—è –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å –Ω—É–ª—è:

```bash
# –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
npm run migrate
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ API

### –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–∏–ª—Å—è:

**–†–∞–Ω—å—à–µ:**
```json
{
  "id": 1,
  "title": "–ë–∞–ª–∞–Ω—Å",
  "city_id": 1,
  "city_name": "–ú–æ—Å–∫–≤–∞"
}
```

**–¢–µ–ø–µ—Ä—å:**
```json
{
  "id": 1,
  "title": "–ë–∞–ª–∞–Ω—Å",
  "city_ids": [1, 2, 3, 4, 5],
  "city_names": ["–£–ª—å—è–Ω–æ–≤—Å–∫", "–ö–∞–∑–∞–Ω—å", "–°–∞–º–∞—Ä–∞", "–¢–æ–ª—å—è—Ç—Ç–∏", "–î–º–∏—Ç—Ä–æ–≤–≥—Ä–∞–¥"]
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã

**–†–∞–Ω—å—à–µ:**
```bash
curl -X POST http://localhost:3000/api/programs \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–î–µ—Ç–æ–∫—Å",
    "emoji": "ü•¨",
    "data": {...},
    "city_id": 1,
    "sort": 5
  }'
```

**–¢–µ–ø–µ—Ä—å:**
```bash
curl -X POST http://localhost:3000/api/programs \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–î–µ—Ç–æ–∫—Å",
    "emoji": "ü•¨",
    "data": {...},
    "city_ids": [1, 2, 3, 4, 5],
    "sort": 5
  }'
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ - —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ–º `city_ids` –≤–º–µ—Å—Ç–æ `city_id`:

```bash
curl -X PUT http://localhost:3000/api/programs/1 \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–ë–∞–ª–∞–Ω—Å –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π",
    "emoji": "‚öñÔ∏è",
    "data": {...},
    "city_ids": [1, 2],
    "sort": 1
  }'
```

### –ù–æ–≤—ã–µ endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤—è–∑—è–º–∏

**–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –≥–æ—Ä–æ–¥:**
```bash
POST /api/programs/:programId/cities/:cityId

# –ü—Ä–∏–º–µ—Ä
curl -X POST http://localhost:3000/api/programs/1/cities/3
```

**–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∏–∑ –≥–æ—Ä–æ–¥–∞:**
```bash
DELETE /api/programs/:programId/cities/:cityId

# –ü—Ä–∏–º–µ—Ä
curl -X DELETE http://localhost:3000/api/programs/1/cities/3
```

## –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –≤–æ –≤—Å–µ –≥–æ—Ä–æ–¥–∞

```bash
curl -X POST http://localhost:3000/api/programs \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–î–µ—Ç–æ–∫—Å",
    "emoji": "ü•¨",
    "data": {
      "calories_from": 800,
      "calories_to": 1000,
      "proteins": 60,
      "fats": 30,
      "carbohydrates": 80
    },
    "city_ids": [1, 2, 3, 4, 5],
    "sort": 7
  }'
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ä–æ–¥–∞

```bash
curl -X POST http://localhost:3000/api/programs \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–ü—Ä–µ–º–∏—É–º",
    "emoji": "‚≠ê",
    "data": {...},
    "city_ids": [1, 2],
    "sort": 8
  }'
```

### 3. –î–æ–±–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥

```bash
# –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É #1 –≤ –≥–æ—Ä–æ–¥ #5
curl -X POST http://localhost:3000/api/programs/1/cities/5
```

### 4. –£–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

```bash
# –£–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É #3 –∏–∑ –≥–æ—Ä–æ–¥–∞ #4
curl -X DELETE http://localhost:3000/api/programs/3/cities/4
```

### 5. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

```bash
# –ö–∞–∫ –∏ —Ä–∞–Ω—å—à–µ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
curl "http://localhost:3000/api/programs?city_id=1"
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

### –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥:

**–†–∞–Ω—å—à–µ:**
```javascript
const program = {
  title: '–ë–∞–ª–∞–Ω—Å',
  city_id: selectedCity.id,
  ...
};
```

**–¢–µ–ø–µ—Ä—å:**
```javascript
const program = {
  title: '–ë–∞–ª–∞–Ω—Å',
  city_ids: [1, 2, 3, 4, 5], // –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
  ...
};
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
```javascript
// –†–∞–Ω—å—à–µ
<p>–ì–æ—Ä–æ–¥: {program.city_name}</p>

// –¢–µ–ø–µ—Ä—å
<p>–ì–æ—Ä–æ–¥–∞: {program.city_names.join(', ')}</p>
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# 1. –í—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
curl http://localhost:3000/api/programs

# 2. –ü—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞
curl "http://localhost:3000/api/programs?city_id=1"

# 3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å —Ü–µ–Ω–∞–º–∏
curl http://localhost:3000/api/programs/1/prices

# 4. –î–∞–Ω–Ω—ã–µ –≤ –ë–î –Ω–∞–ø—Ä—è–º—É—é
psql -U postgres -d fitbox -c "
  SELECT np.title, array_agg(c.title) as cities
  FROM nutrition_programs np
  JOIN city_nutrition_programs cnp ON np.id = cnp.nutrition_program_id
  JOIN cities c ON cnp.city_id = c.id
  GROUP BY np.id, np.title;
"
```

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è:

```bash
# 1. –£–¥–∞–ª–∏—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
psql -U postgres -d fitbox -c "DROP TABLE IF EXISTS city_nutrition_programs;"

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
# (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –î–û –º–∏–≥—Ä–∞—Ü–∏–∏!)

# 3. –ò–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î –∑–∞–Ω–æ–≤–æ
dropdb fitbox
createdb fitbox
psql -U postgres -d fitbox -f migrations/001_initial_schema.sql
psql -U postgres -d fitbox -f migrations/002_seed_data.sql
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
3. –û—Ç–∫—Ä–æ–π—Ç–µ issue –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
